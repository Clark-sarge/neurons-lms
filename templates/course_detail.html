<!-- templates/course_detail.html -->
{% extends 'base.html' %}

{% block title %}{{ course.code }} - {{ course.title }}{% endblock %}

{% block content %}
<!-- Course Header -->
<div class="course-header bg-primary text-white rounded-3 p-4 mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'course_list' %}" class="text-white-50">Courses</a></li>
                    <li class="breadcrumb-item active text-white">{{ course.code }}</li>
                </ol>
            </nav>
            <h1 class="mb-2">{{ course.title }}</h1>
            <p class="mb-3 opacity-75">{{ course.description }}</p>
            <div class="d-flex gap-4">
                <div class="text-center">
                    <div class="h5 mb-0">{{ course.students.count }}</div>
                    <small class="opacity-75">Students</small>
                </div>
                <div class="text-center">
                    <div class="h5 mb-0">{{ modules.count }}</div>
                    <small class="opacity-75">Modules</small>
                </div>
                <div class="text-center">
                    <div class="h5 mb-0">
                        {% for module in modules %}
                            {{ module.content_items.count|add:0 }}
                        {% endfor %}
                    </div>
                    <small class="opacity-75">Content Items</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            {% if user.role != 'student' %}
            <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#addModuleModal">
                <i class="fas fa-plus"></i> Add Module
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Course Content -->
{% if modules %}
    {% for module in modules %}
    <div class="card module-card border-start border-primary border-4 mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-outline-secondary me-2 module-toggle" data-bs-target="#module-{{ module.id }}" type="button">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <h5 class="mb-0">{{ module.title }}</h5>
                {% if module.is_published %}
                    <span class="badge bg-success ms-2">Published</span>
                {% else %}
                    <span class="badge bg-secondary ms-2">Draft</span>
                {% endif %}
            </div>
            
            {% if user.role != 'student' %}
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i> Manage
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-edit"></i> Edit Module</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-plus"></i> Add Sub-module</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Add Content</h6></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file"></i> File</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-link"></i> Link</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-question-circle"></i> Quiz</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-comments"></i> Discussion</a></li>
                </ul>
            </div>
            {% endif %}
        </div>
        
        <div class="card-body collapse show" id="module-{{ module.id }}">
            {% if module.description %}
            <p class="card-text">{{ module.description }}</p>
            {% endif %}
            
            <!-- Content Items -->
            {% for content in module.content_items.all %}
            <div class="content-item bg-light rounded p-3 mb-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    {% if content.content_type == 'file' %}
                        <i class="fas fa-file-alt text-primary fa-lg me-3"></i>
                    {% elif content.content_type == 'link' %}
                        <i class="fas fa-external-link-alt text-info fa-lg me-3"></i>
                    {% elif content.content_type == 'quiz' %}
                        <i class="fas fa-question-circle text-warning fa-lg me-3"></i>
                    {% elif content.content_type == 'discussion' %}
                        <i class="fas fa-comments text-success fa-lg me-3"></i>
                    {% endif %}
                    
                    <div>
                        <h6 class="mb-1">{{ content.title }}</h6>
                        {% if content.description %}
                        <small class="text-muted">{{ content.description|truncatewords:10 }}</small>
                        {% endif %}
                        <div class="mt-1">
                            <span class="badge bg-{{ content.content_type|yesno:'primary,info,warning,success' }} badge-sm">
                                {{ content.get_content_type_display|upper }}
                            </span>
                            {% if not content.is_published %}
                                <span class="badge bg-secondary badge-sm">DRAFT</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-2">
                    {% if user.role == 'student' %}
                        <button class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-play"></i> Open
                        </button>
                    {% else %}
                        <small class="text-muted me-2">
                            {% if content.content_type == 'file' and content.file_content %}
                                Downloaded {{ content.file_content.download_count }} times
                            {% elif content.content_type == 'link' and content.link_content %}
                                Clicked {{ content.link_content.click_count }} times
                            {% endif %}
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4 text-muted">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p>No content in this module yet.</p>
                {% if user.role != 'student' %}
                <small>Use the "Manage" button above to add content.</small>
                {% endif %}
            </div>
            {% endfor %}
            
            <!-- Sub-modules -->
            {% for submodule in module.children.all %}
            <div class="card mt-3 ms-4 border-start border-secondary border-2">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-angle-right me-1"></i>
                            {{ submodule.title }}
                        </h6>
                        {% if submodule.is_published %}
                            <span class="badge bg-success">Published</span>
                        {% else %}
                            <span class="badge bg-secondary">Draft</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if submodule.description %}
                    <p class="card-text">{{ submodule.description }}</p>
                    {% endif %}
                    
                    {% for subcontent in submodule.content_items.all %}
                    <div class="content-item bg-white rounded p-2 mb-2 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if subcontent.content_type == 'file' %}
                                <i class="fas fa-file text-primary me-2"></i>
                            {% elif subcontent.content_type == 'link' %}
                                <i class="fas fa-link text-info me-2"></i>
                            {% elif subcontent.content_type == 'quiz' %}
                                <i class="fas fa-question text-warning me-2"></i>
                            {% elif subcontent.content_type == 'discussion' %}
                                <i class="fas fa-comment text-success me-2"></i>
                            {% endif %}
                            <span>{{ subcontent.title }}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    {% empty %}
                    <p class="text-muted small">No content in this sub-module.</p>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="text-center py-5">
    <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
    <h4 class="text-muted">No Modules Yet</h4>
    <p class="text-muted">
        {% if user.role == 'student' %}
            Your instructor hasn't added any modules to this course yet.
        {% else %}
            Get started by creating your first module for this course.
        {% endif %}
    </p>
    {% if user.role != 'student' %}
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addModuleModal">
        <i class="fas fa-plus"></i> Create First Module
    </button>
    {% endif %}
</div>
{% endif %}

<!-- Add Module Modal -->
{% if user.role != 'student' %}
<div class="modal fade" id="addModuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Module</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_module">
                    <div class="mb-3">
                        <label for="moduleTitle" class="form-label">Module Title *</label>
                        <input type="text" class="form-control" name="title" id="moduleTitle" placeholder="e.g., Week 1: Introduction" required>
                    </div>
                    <div class="mb-3">
                        <label for="moduleDescription" class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="moduleDescription" rows="3" placeholder="Brief description of this module..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="parentModule" class="form-label">Parent Module (Optional)</label>
                        <select class="form-select" name="parent" id="parentModule">
                            <option value="">-- Top Level Module --</option>
                            {% for module in modules %}
                            <option value="{{ module.id }}">{{ module.title }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Select a parent to create a sub-module</small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_published" id="publishModule" checked>
                        <label class="form-check-label" for="publishModule">
                            Publish immediately
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Module</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.module-card {
    transition: all 0.3s ease;
}
.module-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.content-item {
    transition: background-color 0.2s ease;
}
.content-item:hover {
    background-color: #e9ecef !important;
}
.module-toggle .fa-chevron-down {
    transition: transform 0.3s ease;
}
.module-toggle[aria-expanded="false"] .fa-chevron-down {
    transform: rotate(-90deg);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Module toggle functionality
    document.querySelectorAll('.module-toggle').forEach(button => {
        button.addEventListener('click', function() {
            const target = document.querySelector(this.dataset.bsTarget);
            const icon = this.querySelector('.fas');
            
            if (target.classList.contains('show')) {
                target.classList.remove('show');
                icon.style.transform = 'rotate(-90deg)';
                this.setAttribute('aria-expanded', 'false');
            } else {
                target.classList.add('show');
                icon.style.transform = 'rotate(0deg)';
                this.setAttribute('aria-expanded', 'true');
            }
        });
    });
});
</script>
{% endblock %}